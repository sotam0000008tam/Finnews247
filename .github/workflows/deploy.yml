name: "üöÄ Deploy Finnews247 to Windows VPS"

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'data/**'
      - 'pages/**'
      - 'components/**'
      - 'public/**'
      - 'lib/**'
      - 'next.config.js'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üìÅ Ensure target folders
        shell: powershell
        run: |
          $dst = 'C:\apps\finnews247'
          New-Item -ItemType Directory -Force -Path $dst | Out-Null
          New-Item -ItemType Directory -Force -Path "$dst\logs" | Out-Null
          New-Item -ItemType Directory -Force -Path "$dst\scripts" | Out-Null

      - name: üõë Stop scheduled task (if running)
        shell: powershell
        run: |
          schtasks /End /TN "finnews247" 2>$null
          Start-Sleep -Seconds 2

      - name: üîÑ Sync repo ‚Üí C:\apps\finnews247 (mirror, keep logs & scripts)
        shell: powershell
        run: |
          $src = "${env:GITHUB_WORKSPACE}"
          $dst = 'C:\apps\finnews247'
          robocopy $src $dst /MIR /XD .git .github node_modules .next logs scripts /XF start_finnews247.cmd | Out-Null
          $code = $LASTEXITCODE
          if ($code -le 7) { exit 0 } else { exit $code }

      - name: üßπ Strip BOM from JSON (prevent 500)
        shell: powershell
        run: |
          $dir = 'C:\apps\finnews247\data'
          if (Test-Path $dir) {
            Get-ChildItem $dir -Filter *.json -Recurse | ForEach-Object {
              $bytes = [System.IO.File]::ReadAllBytes($_.FullName)
              if ($bytes.Length -ge 3 -and $bytes[0] -eq 0xEF -and $bytes[1] -eq 0xBB -and $bytes[2] -eq 0xBF) {
                $content = [System.Text.Encoding]::UTF8.GetString($bytes,3,$bytes.Length-3)
                [System.IO.File]::WriteAllText($_.FullName, $content, [System.Text.Encoding]::UTF8)
              }
            }
          }

      - name: üü¢ Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: üì¶ Install dependencies
        shell: cmd
        working-directory: C:\apps\finnews247
        run: |
          echo Node: && node -v
          echo npm: && npm -v
          rem C√†i theo lockfile; KH√îNG d√πng --include=dev
          call npm ci --no-audit --no-fund
          if errorlevel 1 (
            echo [warn] npm ci failed -> fallback npm install
            call npm install --no-audit --no-fund
            if errorlevel 1 exit /b 1
          )

      - name: üèóÔ∏è Build (Next.js)
        shell: cmd
        working-directory: C:\apps\finnews247
        env:
          NODE_ENV: production
        run: |
          call npm run build

      - name: üßæ Create start script
        shell: powershell
        run: |
          $dst = 'C:\apps\finnews247'
          $script = @"
          @echo off
          cd /d C:\apps\finnews247
          set "NODE_ENV=production"
          "C:\Program Files\nodejs\node.exe" node_modules\next\dist\bin\next start -p 80 1>>"C:\apps\finnews247\logs\out.log" 2>>"C:\apps\finnews247\logs\err.log"
          "@
          Set-Content -Path "$dst\start_finnews247.cmd" -Value $script -Encoding ASCII -NoNewline

      - name: üß∞ Create helper scripts (restart + warm)
        shell: powershell
        run: |
          $dir = 'C:\apps\finnews247\scripts'
          New-Item -ItemType Directory -Force -Path $dir | Out-Null
          $warm = @"
          @echo off
          setlocal
          cd /d C:\apps\finnews247

          rem kill process on port 80 (n·∫øu c√≥)
          for /f "tokens=5" %%p in ('netstat -ano ^| findstr LISTENING ^| findstr ":80"') do taskkill /F /PID %%p >nul 2>&1

          rem start scheduled task
          schtasks /Run /TN "finnews247" >nul 2>&1
          timeout /t 3 >nul

          rem warm homepage
          curl -s -I http://127.0.0.1/ >nul

          rem warm static assets
          for /f %%f in ('dir /b .next\static\css\*.css 2^>NUL') do curl -s -o NUL http://127.0.0.1/_next/static/css/%%f
          for /f %%f in ('dir /b .next\static\chunks\*.js 2^>NUL') do curl -s -o NUL http://127.0.0.1/_next/static/chunks/%%f

          rem warm m·ªôt ·∫£nh hero (ƒë·ªïi t√™n n·∫øu c·∫ßn)
          set "IMG=news94.jpg"
          for %%w in (320 640 828 1080 1200 1920) do curl -s -o NUL "http://127.0.0.1/_next/image?url=%%2Fimages%%2F%IMG%&w=%%w&q=75"

          endlocal
          "@
          Set-Content -Path "$dir\restart-and-warm.bat" -Value $warm -Encoding ASCII -NoNewline

          $poll = @"
          @echo off
          setlocal
          curl -s -I http://127.0.0.1/ >nul
          if not "%ERRORLEVEL%"=="0" (
            call C:\apps\finnews247\scripts\restart-and-warm.bat
          )
          endlocal
          "@
          Set-Content -Path "$dir\auto-deploy-poll.bat" -Value $poll -Encoding ASCII -NoNewline

      - name: üóìÔ∏è Create/Update Windows Scheduled Task
        shell: powershell
        run: |
          $taskName = "finnews247"
          $exists = schtasks /Query /TN $taskName 2>$null
          if (-not $?) {
            schtasks /Create /TN $taskName /SC ONSTART /RU SYSTEM /RL HIGHEST /TR "C:\apps\finnews247\start_finnews247.cmd" /F
          } else {
            schtasks /Change /TN $taskName /TR "C:\apps\finnews247\start_finnews247.cmd"
          }

      - name: ‚ñ∂Ô∏è Start app & health check
        shell: powershell
        run: |
          schtasks /Run /TN "finnews247" | Out-Null
          Start-Sleep -Seconds 3
          try {
            $r = Invoke-WebRequest -Uri "http://127.0.0.1/" -UseBasicParsing -TimeoutSec 10
            if ($r.StatusCode -ge 500) { throw "Bad status: $($r.StatusCode)" }
          } catch {
            Write-Host "---- out.log (tail) ----"
            if (Test-Path C:\apps\finnews247\logs\out.log) { Get-Content C:\apps\finnews247\logs\out.log -Tail 200 }
            Write-Host "---- err.log (tail) ----"
            if (Test-Path C:\apps\finnews247\logs\err.log) { Get-Content C:\apps\finnews247\logs\err.log -Tail 200 }
            throw "Health check failed: $($_.Exception.Message)"
          }

      - name: üî• Warm cache (optional)
        shell: cmd
        run: |
          call C:\apps\finnews247\scripts\restart-and-warm.bat
