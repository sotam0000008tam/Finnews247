name: "🚀 Deploy Finnews247 to Windows VPS"

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'data/**'
      - 'pages/**'
      - 'components/**'
      - 'public/**'
      - 'lib/**'
      - 'next.config.js'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📁 Ensure target folders
        shell: cmd
        run: |
          if not exist C:\apps\finnews247 mkdir C:\apps\finnews247
          if not exist C:\apps\finnews247\logs mkdir C:\apps\finnews247\logs
          if not exist C:\apps\finnews247\scripts mkdir C:\apps\finnews247\scripts

      - name: 🛑 Stop scheduled task (if running) & free port 80
        shell: cmd
        run: |
          schtasks /End /TN "finnews247" 2>nul
          for /f "tokens=5" %%p in ('netstat -ano ^| findstr LISTENING ^| findstr ":80"') do taskkill /F /PID %%p 1>nul 2>nul

      - name: 🔄 Sync repo → C:\apps\finnews247 (mirror, keep logs & scripts)
        shell: cmd
        run: |
          set SRC=%GITHUB_WORKSPACE%
          set DST=C:\apps\finnews247
          rem Giữ logs và scripts, không copy .git .github node_modules .next
          robocopy "%SRC%" "%DST%" /MIR /XD .git .github node_modules .next logs scripts /XF start_finnews247.cmd
          set RC=%ERRORLEVEL%
          rem Robocopy: 0..7 = success
          if %RC% LEQ 7 (exit /b 0) else (exit /b %RC%)

      - name: 🧹 Strip BOM from JSON (prevent 500)
        shell: powershell
        run: |
          $dir = 'C:\apps\finnews247\data'
          if (Test-Path $dir) {
            Get-ChildItem $dir -Filter *.json -Recurse | ForEach-Object {
              $bytes = [System.IO.File]::ReadAllBytes($_.FullName)
              if ($bytes.Length -ge 3 -and $bytes[0] -eq 0xEF -and $bytes[1] -eq 0xBB -and $bytes[2] -eq 0xBF) {
                $content = [System.Text.Encoding]::UTF8.GetString($bytes,3,$bytes.Length-3)
                [System.IO.File]::WriteAllText($_.FullName, $content, [System.Text.Encoding]::UTF8)
              }
            }
          }

      - name: 🟢 Node & npm versions
        shell: cmd
        working-directory: C:\apps\finnews247
        run: |
          where node
          where npm
          node -v
          npm -v

      - name: 📦 Install dependencies (ci → fallback install)
        shell: cmd
        working-directory: C:\apps\finnews247
        run: |
          call npm ci --no-audit --no-fund
          if errorlevel 1 (
            echo [warn] npm ci failed -> fallback npm install
            call npm install --no-audit --no-fund
            if errorlevel 1 exit /b 1
          )

      - name: 🏗️ Build (Next.js)
        shell: cmd
        working-directory: C:\apps\finnews247
        env:
          NODE_ENV: production
          CI: 0
        run: |
          call npm run build

      - name: 🧾 Create start script
        shell: cmd
        run: |
          > C:\apps\finnews247\start_finnews247.cmd (
            echo @echo off
            echo cd /d C:\apps\finnews247
            echo set "NODE_ENV=production"
            echo "C:\Program Files\nodejs\node.exe" node_modules\next\dist\bin\next start -p 80 1^>^>"C:\apps\finnews247\logs\out.log" 2^>^>"C:\apps\finnews247\logs\err.log"
          )

      - name: 🧰 Create helper scripts (restart + warm)
        shell: cmd
        run: |
          > C:\apps\finnews247\scripts\restart-and-warm.bat (
            echo @echo off
            echo setlocal
            echo cd /d C:\apps\finnews247
            echo for /f "tokens=5" %%%%p in ^('netstat -ano ^^^| findstr LISTENING ^^^| findstr ":80"^) do taskkill /F /PID %%%%p ^>nul 2^>^&1
            echo schtasks /Run /TN "finnews247" ^>nul 2^>^&1
            echo timeout /t 3 ^>nul
            echo curl -s -I http://127.0.0.1/ ^>nul
            echo for /f %%%%f in ^('dir /b .next\static\css\*.css 2^^^>NUL'^) do curl -s -o NUL http://127.0.0.1/_next/static/css/%%%%f
            echo for /f %%%%f in ^('dir /b .next\static\chunks\*.js 2^^^>NUL'^) do curl -s -o NUL http://127.0.0.1/_next/static/chunks/%%%%f
            echo set "IMG=news94.jpg"
            echo for %%%%w in ^(320 640 828 1080 1200 1920^) do curl -s -o NUL "http://127.0.0.1/_next/image?url=%%2Fimages%%2F%%25IMG%%25^&w=%%%%w^&q=75"
            echo endlocal
          )
          > C:\apps\finnews247\scripts\auto-deploy-poll.bat (
            echo @echo off
            echo setlocal
            echo curl -s -I http://127.0.0.1/ ^>nul
            echo if not "%%ERRORLEVEL%%"=="0" (
            echo   call C:\apps\finnews247\scripts\restart-and-warm.bat
            echo ^)
            echo endlocal
          )

      - name: 🗓️ Create/Update Windows Scheduled Task
        shell: cmd
        run: |
          schtasks /Query /TN "finnews247" 1>nul 2>nul
          if errorlevel 1 (
            schtasks /Create /TN "finnews247" /SC ONSTART /RU SYSTEM /RL HIGHEST /TR "C:\apps\finnews247\start_finnews247.cmd" /F
          ) else (
            schtasks /Change /TN "finnews247" /TR "C:\apps\finnews247\start_finnews247.cmd"
          )

      - name: ▶️ Start app & health check
        shell: cmd
        run: |
          schtasks /Run /TN "finnews247" 1>nul 2>nul
          timeout /t 3 >nul
          for /f "tokens=2 delims=:" %%s in ('powershell -NoProfile -Command "(Invoke-WebRequest -Uri 'http://127.0.0.1/' -UseBasicParsing).StatusCode"') do set CODE=%%s
          rem Nếu powershell ở trên không ra code thì dùng curl fallback
          if "%CODE%"=="" (
            for /f "tokens=2 delims= " %%h in ('curl -s -o NUL -w "HTTP %%{http_code}" http://127.0.0.1/') do set CODE=%%h
          )
          echo Health HTTP %CODE%
          if "%CODE%"=="200" (exit /b 0) else (
            echo ---- out.log (tail) ----
            powershell -NoProfile -Command "if (Test-Path 'C:\apps\finnews247\logs\out.log') { Get-Content 'C:\apps\finnews247\logs\out.log' -Tail 200 }"
            echo ---- err.log (tail) ----
            powershell -NoProfile -Command "if (Test-Path 'C:\apps\finnews247\logs\err.log') { Get-Content 'C:\apps\finnews247\logs\err.log' -Tail 200 }"
            exit /b 1
          )

      - name: 🔥 Re-warm cache (optional)
        shell: cmd
        run: |
          call C:\apps\finnews247\scripts\restart-and-warm.bat
