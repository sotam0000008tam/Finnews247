name: 🚀 Deploy Finnews247 to Windows VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ⬇️ Checkout
        uses: actions/checkout@v4

      - name: 📁 Ensure target folders
        shell: powershell
        run: |
          $dst = 'C:\apps\finnews247'
          New-Item -ItemType Directory -Force -Path $dst | Out-Null
          New-Item -ItemType Directory -Force -Path "$dst\logs" | Out-Null

      - name: 📤 Copy repo -> C:\apps\finnews247 (keep logs)
        shell: powershell
        run: |
          robocopy "${{ github.workspace }}" "C:\apps\finnews247" /MIR /XD .git .github node_modules .next logs
          $rc = $LASTEXITCODE
          if ($rc -le 7) {
            Write-Host "Robocopy OK (exit $rc)"
            exit 0
          } else {
            Write-Error "Robocopy FAILED (exit $rc)"
            exit $rc
          }

      - name: 🟢 Use Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: 📦 Install deps
        shell: powershell
        working-directory: C:\apps\finnews247
        run: |
          if (Test-Path package-lock.json) {
            npm ci
            if ($LASTEXITCODE -ne 0) { npm install }
          } else {
            npm install
          }

      - name: 🏗️ Build
        shell: powershell
        working-directory: C:\apps\finnews247
        run: npm run build

      -- name: 🛑 Stop scheduled task (cmd)
  shell: cmd
  run: |
    schtasks /End /TN "finnews247" 2>nul
    timeout /t 2 >nul

