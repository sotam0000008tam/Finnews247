name: üöÄ Deploy Finnews247 to Windows VPS

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'data/**'
      - 'pages/**'
      - 'components/**'
      - 'public/**'
      - 'lib/**'
      - 'next.config.js'
      - 'next-sitemap.config.js'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üìÅ Ensure target folders
        shell: powershell
        run: |
          $dst = 'C:\apps\finnews247'
          New-Item -ItemType Directory -Force -Path $dst | Out-Null
          New-Item -ItemType Directory -Force -Path "$dst\logs" | Out-Null
          New-Item -ItemType Directory -Force -Path "$dst\scripts" | Out-Null

      - name: üõë Stop scheduled task (if running)
        shell: powershell
        run: |
          schtasks /End /TN "finnews247" 2>$null
          Start-Sleep -Seconds 2

      - name: üîÑ Sync repo ‚Üí C:\apps\finnews247 (mirror, keep logs/scripts)
        shell: powershell
        run: |
          $src = "${env:GITHUB_WORKSPACE}"
          $dst = 'C:\apps\finnews247'
          robocopy $src $dst /MIR /XD .git .github node_modules .next logs scripts | Out-Null
          if ($LASTEXITCODE -gt 7) { exit $LASTEXITCODE }

      - name: üü¢ Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: üì¶ Install dependencies (include dev)
        shell: powershell
        working-directory: C:\apps\finnews247
        env:
          NPM_CONFIG_PRODUCTION: "false"
          NODE_ENV: ""
        run: |
          npm ci --include=dev 2>$null
          if ($LASTEXITCODE -ne 0) { npm install --include=dev }

      - name: ‚úÖ Verify next-sitemap is available
        shell: powershell
        working-directory: C:\apps\finnews247
        run: |
          npx --no-install next-sitemap --version 2>$null
          if ($LASTEXITCODE -ne 0) { npm i -D next-sitemap }

      - name: üèóÔ∏è Build (Next.js)
        shell: powershell
        working-directory: C:\apps\finnews247
        env:
          NODE_ENV: production
        run: |
          npm run build

      - name: üó∫Ô∏è Generate sitemap (defensive)
        shell: powershell
        working-directory: C:\apps\finnews247
        run: |
          if (Test-Path ".\next-sitemap.config.js") {
            npx next-sitemap --config .\next-sitemap.config.js
          }

      - name: üßæ Write start script + warm scripts
        shell: powershell
        run: |
          $dst = 'C:\apps\finnews247'
          # start_finnews247.cmd
          $start = @"
          @echo off
          cd /d C:\apps\finnews247
          set "NODE_ENV=production"
          "C:\Program Files\nodejs\node.exe" node_modules\next\dist\bin\next start -p 80 1>>"C:\apps\finnews247\logs\out.log" 2>>"C:\apps\finnews247\logs\err.log"
          "@
          Set-Content -Path "$dst\start_finnews247.cmd" -Value $start -Encoding ASCII -NoNewline

          # scripts\restart-and-warm.bat
          $warm = @"
          @echo off
          for /f "tokens=5" %%p in ('netstat -ano ^| findstr LISTENING ^| findstr ":80"') do taskkill /F /PID %%p
          schtasks /Run /TN "finnews247"
          timeout /t 3 >NUL
          curl -s -o NUL http://127.0.0.1/
          for /f %%f in ('dir /b .next\static\css\*.css') do curl -s -o NUL http://127.0.0.1/_next/static/css/%%f
          for /f %%f in ('dir /b .next\static\chunks\*.js') do curl -s -o NUL http://127.0.0.1/_next/static/chunks/%%f
          set U=http://127.0.0.1/_next/image?url=%2Fimages%2Fnews94.jpg
          for %%w in (320 640 828 1080 1200 1920) do curl -s -o NUL "%U%&w=%%w&q=75"
          "@
          Set-Content -Path "$dst\scripts\restart-and-warm.bat" -Value $warm -Encoding ASCII -NoNewline

          # scripts\auto-deploy-poll.bat (placeholder n·∫øu b·∫°n c·∫ßn)
          $poll = @"
          @echo off
          echo watcher placeholder
          "@
          Set-Content -Path "$dst\scripts\auto-deploy-poll.bat" -Value $poll -Encoding ASCII -NoNewline

      - name: üóìÔ∏è Create/Update Windows Scheduled Task
        shell: powershell
        run: |
          $taskName = "finnews247"
          if (schtasks /Query /TN $taskName 2>$null) {
            schtasks /Change /TN $taskName /TR "C:\apps\finnews247\start_finnews247.cmd"
          } else {
            schtasks /Create /TN $taskName /SC ONSTART /RU SYSTEM /RL HIGHEST /TR "C:\apps\finnews247\start_finnews247.cmd" /F
          }

      - name: ‚ñ∂Ô∏è Start app & health check
        shell: powershell
        run: |
          schtasks /Run /TN "finnews247" | Out-Null
          Start-Sleep -Seconds 3
          (Invoke-WebRequest -Uri "http://127.0.0.1/" -UseBasicParsing -TimeoutSec 8).StatusCode
